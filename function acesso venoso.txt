CREATE OR REPLACE function TASY.GHAS_OBTER_ACESSO_VENOSO(
                CD_PESSOA_FISICA_P     NUMBER )
                return varchar2 is
-- INFORMAÃ‡ÃƒO ORIUNDA DA AVALIAÃ‡ÃƒO EvoluÃ§Ã£o de Enfermagem Quimioterapia (codigo 1019)
ds_retorno_w        varchar2(255);
NR_SEQ_W        VARCHAR2(255);

begin

SELECT
MAX(a.NR_SEQUENCIA)
INTO
NR_SEQ_W
FROM
MED_AVALIACAO_PACIENTE a
WHERE
A.CD_PESSOA_FISICA = CD_PESSOA_FISICA_P
AND
A.NR_SEQ_TIPO_AVALIACAO IN ('1019','159');


select
nvl(OBTER_DESC_RESULT_AVALIACAO(MAX(A.NR_SEQUENCIA),9285),OBTER_DESC_RESULT_AVALIACAO(MAX(A.NR_SEQUENCIA),12575)) DS_ACESSO_VENOSO
INTO
ds_retorno_w
from
MED_AVALIACAO_PACIENTE A
where
A.CD_PESSOA_FISICA = CD_PESSOA_FISICA_P
and
a.nr_sequencia = NR_SEQ_W
and
A.NR_SEQ_TIPO_AVALIACAO IN ('1019','159');

return ds_retorno_w;

end GHAS_OBTER_ACESSO_VENOSO;
/





Banda do acesso venoso

SELECT 
PM.NR_ATENDIMENTO NR_ATEND_BARRAS,
'Prescrição: ' || (SELECT A.NR_PRESCRICAO
FROM PACIENTE_ATENDIMENTO  A
LEFT JOIN PRESCR_MEDICA PM ON A.NR_PRESCRICAO = PM.NR_PRESCRICAO
WHERE A.NR_SEQ_PACIENTE = :NR_SEQ_PACIENTE
AND A.NR_SEQ_ATENDIMENTO = :NR_SEQ_ATENDIMENTO
AND A.NR_CICLO = :NR_CICLO) NR_PRESCRICAO,
(SELECT A.NR_PRESCRICAO
FROM PACIENTE_ATENDIMENTO  A
LEFT JOIN PRESCR_MEDICA PM ON A.NR_PRESCRICAO = PM.NR_PRESCRICAO
 WHERE A.NR_SEQ_PACIENTE = :NR_SEQ_PACIENTE
AND A.NR_SEQ_ATENDIMENTO = :NR_SEQ_ATENDIMENTO
AND A.NR_CICLO = :NR_CICLO) NR_PRESCRICAO_BARRAS,
'Atendimento: ' || PM.NR_ATENDIMENTO NR_ATENDIMENTO,
'Prontuário: '  ||  DECODE(OBTER_PRONTUARIO_PF(A.CD_ESTABELECIMENTO,A.CD_PESSOA_FISICA),0,B.NR_PRONTUARIO,OBTER_PRONTUARIO_PF(A.CD_ESTABELECIMENTO,A.CD_PESSOA_FISICA)) NR_PRONTUARIO,
UPPER(B.NM_PESSOA_FISICA)NM_PACIENTE,
UPPER (B.NM_SOCIAL)  SOCIAL,
UPPER (B.DS_OBSERVACAO)  DS_OBSERVACAO,
B.DT_NASCIMENTO,
OBTER_IDADE(B.DT_NASCIMENTO, SYSDATE, 'C') DS_IDADE,
DECODE(B.IE_SEXO,'M','Masculino','I','Indefinido','F','Feminino') IE_SEXO,      
GHAS_OBTER_ALERGIAS_RELAT(A.CD_PESSOA_FISICA)ALERGIA,
--pa.QT_ALTURA || ' (cm) x ' || pa.qt_peso  || ' (kg)' PESO_ALT,
PA.QT_ALTURA || ' (cm) x ' || TASY.GHAS_OBTER_ULTIMO_PESO_PF(A.CD_PESSOA_FISICA)  || ' (kg)' PESO_ALT,
GHAS_OBTER_SUPERFICIE_CORP (A.CD_PESSOA_FISICA) || ' m2'  || ' - Redução SC: ' || A.QT_REDUTOR_SC || ' %'  QT_SUPERF_CORPORAL, -- NOVO AJUSTE SUPERFICE CORPORAL - 20/05/21
TO_CHAR (PA.QT_SUPERF_CORPORAL, '0D999') || ' m2'  || ' - Redução SC: ' || A.QT_REDUTOR_SC || ' %' QT_SUPERF_CORPORAL,
OBTER_DESC_SETOR_ATEND(A.CD_SETOR_ATENDIMENTO) DS_SETOR,          
OBTER_DESC_CONVENIO(OBTER_CONVENIO_ATENDIMENTO(PA.NR_ATENDIMENTO)) CONVENIO,
--OBTER_DESC_PROF_SIG_UF_COD((select    max(nm_usuario)from usuario where cd_pessoa_fisica = A.CD_MEDICO_RESP)) NM_MEDICO,
OBTER_NOME_PF (A.CD_MEDICO_RESP)NM_MEDICO,
NVL(OBTER_DESC_CID_DOENCA(C.CD_DOENCA_CID),(SELECT OBTER_DESC_CID_DOENCA(Z.CD_DOENCA_CID) FROM CAN_LOCO_REGIONAL Z WHERE Z.CD_PESSOA_FISICA = A.CD_PESSOA_FISICA AND Z.DT_INATIVACAO IS NULL 
AND Z.NR_SEQUENCIA = (SELECT MAX(Y.NR_SEQUENCIA) FROM CAN_LOCO_REGIONAL Y WHERE Y.DT_INATIVACAO IS NULL AND Z.CD_PESSOA_FISICA = Y.CD_PESSOA_FISICA)
)) DS_DIAGNOSTICO,     
NVL(NVL(C.CD_ESTADIAMENTO,(SELECT Z.CD_ESTADIAMENTO FROM CAN_LOCO_REGIONAL Z WHERE Z.CD_PESSOA_FISICA = A.CD_PESSOA_FISICA AND Z.DT_INATIVACAO IS NULL 
AND Z.NR_SEQUENCIA = (SELECT MAX(Y.NR_SEQUENCIA) FROM CAN_LOCO_REGIONAL Y WHERE Y.DT_INATIVACAO IS NULL AND Z.CD_PESSOA_FISICA = Y.CD_PESSOA_FISICA)
)),C.CD_ESTADIO_OUTRO) DS_ESTADIAMENTO,
CASE 
WHEN PM.CD_ESTABELECIMENTO IN (28,31,34)  AND PM.NR_ATENDIMENTO IS NULL OR PM.CD_ESTABELECIMENTO IN (28,31,34) AND OBTER_CLINICA_ATEND(PM.NR_ATENDIMENTO,'C') <> 10 THEN ''
--when pm.cd_estabelecimento =31 and trunc (pm.dt_prescricao) < trunc (sysdate) then ''
WHEN PM.CD_ESTABELECIMENTO IN (28,31,34)  AND OBTER_SE_CONS_PEPA_LIBERADA(PM.NR_ATENDIMENTO) = 'N' THEN ''
WHEN PM.CD_ESTABELECIMENTO in (31,34) AND TRUNC (OBTER_DATA_ENTRADA(PM.NR_ATENDIMENTO)) < TRUNC (SYSDATE) THEN ''
WHEN PM.CD_ESTABELECIMENTO in (31,34) AND TRUNC (PA.DT_PREVISTA) < TRUNC (SYSDATE) THEN ''
ELSE OBTER_DESC_PROTOCOLO_ONCO(A.NR_SEQ_PACIENTE)
END NM_MEDICACAO,
PM.CD_ESTABELECIMENTO,
OBTER_CLINICA_ATEND(PM.NR_ATENDIMENTO,'C') TIPO_CLINICA,
GHAS_OBTER_ACESSO_VENOSO(A.CD_PESSOA_FISICA) DS_ACESSO_VENOSO   
FROM  PACIENTE_ATENDIMENTO PA
INNER JOIN PACIENTE_SETOR A  
ON PA.NR_SEQ_PACIENTE = A.NR_SEQ_PACIENTE
INNER JOIN PESSOA_FISICA  B ON A.CD_PESSOA_FISICA  = B.CD_PESSOA_FISICA
LEFT JOIN CAN_LOCO_REGIONAL C ON A.NR_SEQ_LOCO_REGIONAL = C.NR_SEQUENCIA
LEFT JOIN PRESCR_MEDICA PM
ON PA.NR_PRESCRICAO = PM.NR_PRESCRICAO
WHERE 1=1
AND PA.NR_SEQ_ATENDIMENTO = :NR_SEQ_ATENDIMENTO






CREATE OR REPLACE function TASY.GHAS_OBTER_ACESSO_VENOSO(
                CD_PESSOA_FISICA_P     NUMBER )
                return varchar2 is
-- INFORMAÃ‡ÃƒO ORIUNDA DA AVALIAÃ‡ÃƒO EvoluÃ§Ã£o de Enfermagem Quimioterapia (codigo 1019)
ds_retorno_w        varchar2(255);
NR_SEQ_W        VARCHAR2(255);

begin

SELECT
MAX(a.NR_SEQUENCIA)
INTO
NR_SEQ_W
FROM
MED_AVALIACAO_PACIENTE a
WHERE
A.CD_PESSOA_FISICA = CD_PESSOA_FISICA_P
AND
A.NR_SEQ_TIPO_AVALIACAO IN ('1019','159','157')
AND A.DT_LIBERACAO IS NOT NULL
AND A.DT_INATIVACAO IS NULL;


select
case when NR_SEQ_TIPO_AVALIACAO = '1019' then OBTER_DESC_RESULT_AVALIACAO(MAX(A.NR_SEQUENCIA),9285)
     when NR_SEQ_TIPO_AVALIACAO = '159'  then OBTER_DESC_RESULT_AVALIACAO(MAX(A.NR_SEQUENCIA),12575)
     when NR_SEQ_TIPO_AVALIACAO = '157'  then OBTER_DESC_RESULT_AVALIACAO(MAX(A.NR_SEQUENCIA),11841)
     else 'Sem acesso Venoso' end DS_ACESSO_VENOSO
INTO
ds_retorno_w
from
MED_AVALIACAO_PACIENTE A
where
A.CD_PESSOA_FISICA = CD_PESSOA_FISICA_P
and
a.nr_sequencia = NR_SEQ_W
and
A.NR_SEQ_TIPO_AVALIACAO IN ('1019','159','157')
group by  NR_SEQ_TIPO_AVALIACAO;

return ds_retorno_w;

end GHAS_OBTER_ACESSO_VENOSO;
/

